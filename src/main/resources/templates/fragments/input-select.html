<html lang="en">
<!--/*@thymesVar id="label" type="java.lang.String"*/-->
<!--/*@thymesVar id="id" type="java.lang.String"*/-->
<!--/*@thymesVar id="name" type="java.lang.String"*/-->
<!--/*@thymesVar id="ref" type="java.lang.String"*/-->
<!--/*@thymesVar id="text" type="java.lang.String"*/-->

<th:block th:fragment="params(label, id, name, ref)">
    <input type="hidden" th:id="${id}" th:name="${id}" th:value="*{__${id}__}">
    <input type="hidden" th:id="${name}" th:name="${name}" th:value="*{__${name}__}">
    <label class="form-label" th:if="${!label.isEmpty()}"
           th:for="|${id}_text|" th:text="${label}"></label>
    <input class="form-control" th:id="|${id}_text|" th:value="*{__${name}__}">
    <script>
        $(document).ready(function() {
            const textInput = $("input[id='" + "[[|${id}_text|]]" + "']");
            const hiddenIdInput = $("input[id='" + "[[|${id}|]]" + "']");
            const hiddenNameInput = $("input[id='" + "[[|${name}|]]" + "']");
            textInput.autocomplete({
                source: "[[${ref}]]",
                delay: 250,
                select: function( event, ui ) {
                    hiddenIdInput.val(ui.item.id);
                    hiddenNameInput.val(ui.item.value);
                },
                close: function( event, ui ) {
                    const oe = event.originalEvent;
                    if ((oe.type === 'blur') || (oe.type === 'keydown' && event.key === 'Escape')) {
                        textInput.val(hiddenNameInput.val());
                    }
                }
            });
        })
    </script>
</th:block>

</html>
